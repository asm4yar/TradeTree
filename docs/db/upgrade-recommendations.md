# Рекомендации по обновлению

1. Избавиться от рекурсивного подъёма категорий в отчётах `v_top5..`
2. Использовать Closure Table, вместо хранения прямых связей (родитель-потомок), хранить все пути между узлами
3. Денормализация в products, добавить колонку root_category_id
4. Использовать materialized path / ltree PostgreSQL
5. Предагрегация продаж
6. [Анализ запроса](./explain_analyze.md)


## При высокой нагрузке важно:
- транзакция,
- блокировка строки товара SELECT ... FOR UPDATE,
- проверка остатка,
- уменьшение остатка,
- upsert позиции заказа.
 
Это как раз реализовано ниже в сервисе.
